<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://js.stripe.com/v3/"></script>

<div id="booking-widget-root">
    <div class="b-loading">Загрузка v56...</div>
</div>

<style>
    /* === V56: GRAMMAR FIX + POLISHED DESIGN === */
    #booking-widget-root {
        width: 100%;
        margin: 40px auto;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
    }

    #booking-widget-root * {
        box-sizing: border-box;
    }

    .b-container {
        width: 100%;
        max-width: 480px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* КАРТОЧКИ */
    .b-card {
        background: #fff;
        border-radius: 24px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        border: 1px solid #f0f0f0;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        position: relative;
    }

    .b-card-header {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        background: #fff;
        z-index: 2;
        position: relative;
    }

    .b-card-title {
        font-size: 19px;
        font-weight: 700;
        color: #1d1d1f;
    }

    .b-card-status {
        font-size: 15px;
        font-weight: 500;
        color: #0071e3;
        opacity: 0;
        transform: translateX(10px);
        transition: 0.3s;
    }

    .b-card-body {
        padding: 0 24px 24px 24px;
        opacity: 1;
        max-height: 5000px;
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        transform-origin: top;
    }

    /* STATES */
    .b-card.active {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        transform: scale(1);
        z-index: 10;
    }

    .b-card.done .b-card-body {
        max-height: 0;
        padding-bottom: 0;
        opacity: 0;
    }

    .b-card.done .b-card-status {
        opacity: 1;
        transform: translateX(0);
    }

    .b-card.done {
        background: #fafafc;
        border-color: #eee;
    }

    .b-card.locked {
        opacity: 0.6;
        pointer-events: none;
        filter: grayscale(1);
    }

    .b-card.locked .b-card-body {
        max-height: 0;
        padding-bottom: 0;
    }

    /* ПЛАНЫ ОПЛАТЫ */
    .b-plans-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 24px;
    }

    .b-plan-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #f5f5f7;
        border: 2px solid transparent;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .b-plan-card.selected {
        background: #fff;
        border-color: #0071e3;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
        position: relative;
        z-index: 5;
    }

    .b-left-part {
        display: flex;
        align-items: center;
    }

    .b-radio-circle {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d1d6;
        border-radius: 50%;
        margin-right: 14px;
        position: relative;
        flex-shrink: 0;
        transition: 0.2s;
        background: #fff;
    }

    .b-plan-card.selected .b-radio-circle {
        border-color: #0071e3;
        background: #0071e3;
    }

    .b-plan-card.selected .b-radio-circle::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 5px;
        width: 6px;
        height: 6px;
        background: #fff;
        border-radius: 50%;
    }

    .b-plan-info {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .b-plan-title {
        font-size: 15px;
        font-weight: 700;
        color: #1d1d1f;
    }

    .b-plan-desc {
        font-size: 12px;
        color: #86868b;
        font-weight: 500;
    }

    .b-remainder-amount {
        color: #0071e3;
        font-weight: 800;
    }

    /* СИНИЙ ЦВЕТ ОСТАТКА */
    .b-plan-price {
        font-size: 16px;
        font-weight: 800;
        color: #1d1d1f;
    }

    /* ПАССАЖИРЫ */
    .b-passenger-group {
        background: #fbfbfd;
        border: 1px solid #eee;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
    }

    .b-passenger-title {
        font-size: 13px;
        font-weight: 700;
        color: #1d1d1f;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.7;
    }

    /* ОБЩЕЕ */
    .b-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-top: 1px solid #f5f5f5;
    }

    .b-label {
        font-size: 16px;
        font-weight: 600;
    }

    .b-sub {
        font-size: 13px;
        color: #86868b;
        margin-top: 3px;
    }

    .b-stepper {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f5f5f7;
        padding: 4px 12px;
        border-radius: 12px;
        height: 40px;
    }

    .b-step-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        user-select: none;
        transition: 0.1s;
        padding-bottom: 2px;
    }

    .b-step-val {
        font-size: 17px;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
    }

    /* TOGGLE & MAP */
    .b-switch-wrap {
        cursor: pointer;
    }

    .b-switch {
        position: relative;
        width: 52px;
        height: 32px;
        background: #e9e9ea;
        border-radius: 32px;
        transition: 0.3s;
    }

    .b-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 28px;
        height: 28px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transition: 0.3s cubic-bezier(0.3, 1.5, 0.7, 1);
    }

    .b-switch-wrap.active .b-switch {
        background: #34c759;
    }

    .b-switch-wrap.active .b-switch::after {
        transform: translateX(20px);
    }

    .b-map-container {
        background: #fbfbfd;
        border-radius: 16px;
        border: 1px solid #eee;
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.4s ease-in-out, opacity 0.4s ease;
        opacity: 0;
        margin-top: 10px;
    }

    .b-map-container.open {
        max-height: 800px;
        opacity: 1;
    }

    .b-map-inner {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .b-grid {
        display: grid;
        grid-template-columns: repeat(5, 44px);
        gap: 10px;
    }

    .b-seat {
        width: 44px;
        height: 44px;
        background: #fff;
        border: 1px solid #d1d1d6;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        color: #1d1d1f;
        cursor: pointer;
        transition: 0.1s;
        box-shadow: 0 2px 0 #e5e5ea;
        user-select: none;
    }

    .b-seat.selected {
        background: #34c759;
        color: #fff;
        border-color: #34c759;
        box-shadow: 0 3px 0 #248a3d;
    }

    .b-aisle {
        width: 44px;
        pointer-events: none;
    }

    .b-seat-hint {
        margin-top: 10px;
        font-size: 13px;
        color: #ff3b30;
        font-weight: 500;
        height: 16px;
        opacity: 0;
        transition: 0.2s;
    }

    .b-seat-hint.show {
        opacity: 1;
    }

    /* RECEIPT & INPUTS */
    .b-receipt {
        background: #f5f5f7;
        border-radius: 14px;
        padding: 16px;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .b-receipt-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        color: #555;
        margin-bottom: 8px;
    }

    .b-receipt-row:last-child {
        margin-bottom: 0;
    }

    .b-receipt-row span:last-child {
        font-weight: 600;
        color: #1d1d1f;
    }

    .b-receipt-divider {
        height: 1px;
        background: #e0e0e0;
        margin: 10px 0;
    }

    .b-receipt-total {
        font-weight: 700;
        font-size: 16px;
        color: #1d1d1f;
        display: flex;
        justify-content: space-between;
    }

    .b-input-group {
        margin-bottom: 12px;
    }

    .b-input-label {
        display: block;
        font-size: 13px;
        color: #86868b;
        margin-bottom: 6px;
        font-weight: 500;
    }

    .b-input {
        width: 100%;
        height: 48px;
        border: 1px solid #d1d1d6;
        border-radius: 12px;
        padding: 0 16px;
        font-size: 16px;
        outline: none;
        transition: 0.2s;
        background: #fff;
        font-family: inherit;
        -webkit-appearance: none;
    }

    .b-input:focus {
        border-color: #0071e3;
        box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }

    .b-input.error {
        border-color: #ff3b30;
        background: #fff0f0;
    }

    .b-btn {
        width: 100%;
        padding: 18px;
        border: none;
        border-radius: 16px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        background: #0071e3;
        color: white;
        margin-top: 10px;
    }

    .b-btn:active {
        transform: scale(0.98);
    }

    .b-btn:disabled {
        background: #d1d1d6;
        cursor: not-allowed;
    }

    /* MODAL */
    .b-payment-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2147483647;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: flex-end;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .b-payment-overlay.show {
        opacity: 1;
        pointer-events: auto;
    }

    .b-payment-modal {
        width: 100%;
        max-width: 500px;
        background: #fff;
        border-radius: 24px 24px 0 0;
        padding: 20px;
        max-height: 90vh;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
    }

    @media (min-width: 600px) {
        .b-payment-overlay {
            align-items: center;
        }

        .b-payment-modal {
            border-radius: 24px;
            transform: scale(0.9);
            opacity: 0;
        }

        .b-payment-overlay.show .b-payment-modal {
            transform: scale(1);
            opacity: 1;
        }
    }

    .b-payment-overlay.show .b-payment-modal {
        transform: translateY(0);
    }

    .b-close-cross {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 32px;
        height: 32px;
        background: #f2f2f7;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #555;
        font-size: 20px;
    }

    #stripe-box {
        min-height: 300px;
    }

    .b-loading {
        text-align: center;
        color: #999;
        padding: 40px;
    }
</style>

<script>
    (function () {
        const STRIPE_PK = "pk_live_51SE6PPDcw9kAY89HfWvBpSfQqQ4BvbF5D9cEOkQ1DC5YNK5HARwuhhWZzTEQA6WCoATixBmkEJ8eTbpVUyw96wK0001cNUyYD6";

        // ==========================================
        // ⚙️ ЗОНА РЕДАКТИРОВАНИЯ ДАННЫХ
        // ==========================================
        const CONFIG = {
            webhook: "https://hook.eu2.make.com/t118j4fcirfp3s6srdt97ahsr9hggo63",
            name: "Тур Клиновец",
            priceFull: 1190,
            priceDeposit: 500,
            priceSeat: 100
        };
        // ==========================================

        const ROWS_TEMPLATE = [1, 1, 0, 1, 1];
        const START_ROW = 3;
        const ROW_COUNT = 5;

        let state = { count: 1, payType: 'full', isMapActive: false, selectedSeats: [], step: 1 };
        let stripe = null;
        let checkout = null;

        function init() {
            try { stripe = Stripe(STRIPE_PK); } catch (e) { console.error(e); }
            render();
        }

        function render() {
            const root = document.getElementById('booking-widget-root');
            root.innerHTML = `
        <div class="b-container">
            
            <div class="b-card active" id="card-step-1">
                <div class="b-card-header" id="header-1">
                    <div class="b-card-title">1. Параметры поездки</div>
                    <div class="b-card-status" id="status-1">Изменить</div>
                </div>
                <div class="b-card-body">
                    
                    <div class="b-plans-grid">
                        <div class="b-plan-card selected" id="plan-full">
                            <div class="b-left-part">
                                <div class="b-radio-circle"></div>
                                <div class="b-plan-info">
                                    <div class="b-plan-title">Оплатить полностью</div>
                                    <div class="b-plan-desc">Без доплат в будущем</div>
                                </div>
                            </div>
                            <div class="b-plan-price">${CONFIG.priceFull} Kč</div>
                        </div>

                        <div class="b-plan-card" id="plan-depo">
                            <div class="b-left-part">
                                <div class="b-radio-circle"></div>
                                <div class="b-plan-info">
                                    <div class="b-plan-title">Внести залог</div>
                                    <div class="b-plan-desc">Остаток <span class="b-remainder-amount" id="lbl-remainder">${CONFIG.priceFull - CONFIG.priceDeposit} Kč</span> за 10 дней до тура</div>
                                </div>
                            </div>
                            <div class="b-plan-price">${CONFIG.priceDeposit} Kč</div>
                        </div>
                    </div>

                    <div class="b-row">
                        <div class="b-label">Пассажиры</div>
                        <div class="b-stepper">
                            <div class="b-step-btn" id="btn-minus">–</div>
                            <div class="b-step-val" id="val-cnt">1</div>
                            <div class="b-step-btn" id="btn-plus">+</div>
                        </div>
                    </div>
                    <div class="b-row" id="seat-toggle-row" style="cursor:pointer">
                        <div>
                            <div class="b-label">Выбрать места</div>
                            <div class="b-sub">Доплата +${CONFIG.priceSeat} Kč</div>
                        </div>
                        <div class="b-switch-wrap" id="seat-switch-wrap"><div class="b-switch"></div></div>
                    </div>
                    <div class="b-map-container" id="map-container">
                        <div class="b-map-inner">
                            <div class="b-grid" id="b-grid"></div>
                            <div class="b-seat-hint" id="seat-hint"></div>
                        </div>
                    </div>
                    
                    <div class="b-receipt" id="receipt-1"></div>

                    <button class="b-btn" id="btn-next">Далее</button>
                </div>
            </div>

            <div class="b-card locked" id="card-step-2">
                <div class="b-card-header">
                    <div class="b-card-title">2. Данные пассажиров</div>
                </div>
                <div class="b-card-body">
                    <div id="passengers-list"></div>

                    <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                        <h4 style="margin:0 0 15px 0; font-size:16px;">Покупатель</h4>
                        <div class="b-input-group">
                            <input type="email" class="b-input" id="inp-email" placeholder="Email (для билетов)">
                        </div>
                        <div class="b-input-group">
                            <input type="tel" class="b-input" id="inp-phone" placeholder="Телефон">
                        </div>
                    </div>

                    <div class="b-receipt" id="receipt-2"></div>

                    <button class="b-btn" id="btn-pay">Оплатить</button>
                </div>
            </div>

        </div>

        <div class="b-payment-overlay" id="payment-overlay">
            <div class="b-payment-modal">
                <div class="b-close-cross" id="btn-close-pay">✕</div>
                <h3 style="margin:0 0 20px 0; font-size:22px;">Оплата картой</h3>
                <div id="stripe-box"></div>
            </div>
        </div>
        `;

            bindEvents();
            updateUI();
        }

        function bindEvents() {
            document.getElementById('plan-full').addEventListener('click', function () { setPlan('full'); });
            document.getElementById('plan-depo').addEventListener('click', function () { setPlan('deposit'); });
            document.getElementById('header-1').onclick = () => goToStep(1);
            document.getElementById('seat-toggle-row').onclick = toggleMap;
            document.getElementById('btn-minus').onclick = () => changeCount(-1);
            document.getElementById('btn-plus').onclick = () => changeCount(1);
            document.getElementById('btn-next').onclick = toStep2;
            document.getElementById('btn-pay').onclick = pay;
            document.getElementById('btn-close-pay').onclick = closePay;
            document.getElementById('b-grid').addEventListener('click', function (e) {
                const seatEl = e.target.closest('.b-seat');
                if (seatEl) selectSeat(seatEl.innerText);
            });
        }

        function setPlan(type) {
            state.payType = type;
            document.getElementById('plan-full').classList.toggle('selected', type === 'full');
            document.getElementById('plan-depo').classList.toggle('selected', type === 'deposit');
            updateUI();
        }

        function goToStep(step) {
            if (step === 1) {
                document.getElementById('card-step-1').classList.remove('done', 'locked');
                document.getElementById('card-step-1').classList.add('active');
                document.getElementById('card-step-2').classList.remove('active');
                document.getElementById('card-step-2').classList.add('locked');
            }
        }

        function toStep2() {
            if (state.isMapActive && state.selectedSeats.length < state.count) {
                alert(`Выберите ${state.count} мест(а).`); return;
            }
            const container = document.getElementById('passengers-list');
            container.innerHTML = '';
            for (let i = 0; i < state.count; i++) {
                const group = document.createElement('div');
                group.className = 'b-passenger-group';
                group.innerHTML = `
                <div class="b-passenger-title">Пассажир ${i + 1}</div>
                <div class="b-input-group">
                    <input type="text" class="b-input pass-name" data-id="${i}" placeholder="Имя Фамилия (как в паспорте)">
                </div>
                <div class="b-input-group" style="margin-bottom:0">
                    <input type="text" onfocus="(this.type='date')" onblur="(this.type='text')" class="b-input pass-dob" data-id="${i}" placeholder="Дата рождения">
                </div>
            `;
                container.appendChild(group);
            }
            document.getElementById('card-step-1').classList.remove('active');
            document.getElementById('card-step-1').classList.add('done');
            document.getElementById('status-1').innerText = getSummaryText();
            document.getElementById('card-step-2').classList.remove('locked');
            document.getElementById('card-step-2').classList.add('active');
        }

        function getSummaryText() {
            const type = state.payType === 'full' ? 'Полная' : 'Залог';
            const seats = state.isMapActive ? `Места: ${state.selectedSeats.join(', ')}` : 'Без мест';
            return `${state.count} чел • ${type} • ${seats}`;
        }

        function closePay() {
            document.getElementById('payment-overlay').classList.remove('show');
            if (checkout) { try { checkout.destroy(); } catch (e) { } checkout = null; }
            document.getElementById('stripe-box').innerHTML = '';
            document.getElementById('btn-pay').disabled = false;
            document.getElementById('btn-pay').innerText = "Оплатить";
        }

        function changeCount(diff) {
            if (state.count + diff >= 1 && state.count + diff <= 10) {
                state.count += diff;
                if (state.selectedSeats.length > state.count) {
                    state.selectedSeats = state.selectedSeats.slice(0, state.count);
                    renderGrid();
                }
                updateUI();
            }
        }

        function toggleMap() {
            state.isMapActive = !state.isMapActive;
            const cont = document.getElementById('map-container');
            if (state.isMapActive) { cont.classList.add('open'); renderGrid(); } else { cont.classList.remove('open'); }
            updateUI();
        }

        function renderGrid() {
            const grid = document.getElementById('b-grid');
            grid.innerHTML = '';
            const letters = ['A', 'B', 'X', 'C', 'D'];
            for (let i = 0; i < ROW_COUNT; i++) {
                const r = START_ROW + i;
                ROWS_TEMPLATE.forEach((type, idx) => {
                    if (type === 0) { grid.innerHTML += '<div class="b-aisle"></div>'; return; }
                    const id = r + letters[idx];
                    const isSel = state.selectedSeats.includes(id);
                    grid.innerHTML += `<div class="b-seat ${isSel ? 'selected' : ''}">${id}</div>`;
                });
            }
        }

        // === ФУНКЦИЯ СКЛОНЕНИЯ (РУССКИЙ) ===
        function getNoun(number, one, two, five) {
            let n = Math.abs(number);
            n %= 100;
            if (n >= 5 && n <= 20) { return five; }
            n %= 10;
            if (n === 1) { return one; }
            if (n >= 2 && n <= 4) { return two; }
            return five;
        }

        function selectSeat(id) {
            const idx = state.selectedSeats.indexOf(id);
            const hint = document.getElementById('seat-hint');
            if (idx > -1) { state.selectedSeats.splice(idx, 1); hint.classList.remove('show'); } else {
                if (state.selectedSeats.length < state.count) { state.selectedSeats.push(id); hint.classList.remove('show'); }
                else {
                    // Используем правильное склонение
                    const word = getNoun(state.count, 'место', 'места', 'мест');
                    hint.innerText = `Максимум ${state.count} ${word}`;
                    hint.classList.add('show');
                    setTimeout(() => hint.classList.remove('show'), 2000);
                }
            }
            renderGrid(); updateUI();
        }

        function updateUI() {
            const isFull = state.payType === 'full';
            const wrap = document.getElementById('seat-switch-wrap');
            if (state.isMapActive) wrap.classList.add('active'); else wrap.classList.remove('active');

            document.getElementById('val-cnt').innerText = state.count;

            const base = isFull ? CONFIG.priceFull : CONFIG.priceDeposit;
            const seat = (state.isMapActive) ? CONFIG.priceSeat : 0;
            const total = (base + seat) * state.count;

            const remainder = (CONFIG.priceFull - CONFIG.priceDeposit);
            document.getElementById('lbl-remainder').innerText = remainder + " Kč";

            const receiptHtml = `
            <div class="b-receipt-row">
                <span>${state.count} x ${isFull ? 'Билет' : 'Залог'}</span>
                <span>${state.count * base} Kč</span>
            </div>
            ${state.isMapActive ? `
            <div class="b-receipt-row">
                <span>${state.count} x Место</span>
                <span>${state.count * CONFIG.priceSeat} Kč</span>
            </div>` : ''}
            <div class="b-receipt-divider"></div>
            <div class="b-receipt-total">
                <span>Итого</span>
                <span id="final-price-1">${total} Kč</span>
            </div>
        `;
            document.getElementById('receipt-1').innerHTML = receiptHtml;
            document.getElementById('receipt-2').innerHTML = receiptHtml;

            const btnNext = document.getElementById('btn-next');
            const btnPay = document.getElementById('btn-pay');
            if (state.isMapActive && state.selectedSeats.length < state.count) {
                btnNext.innerText = `Выберите места (${state.selectedSeats.length}/${state.count})`; btnNext.disabled = true;
            } else {
                btnNext.innerText = `Далее`; btnNext.disabled = false;
            }
            btnPay.innerText = `Оплатить ${total} Kč`;
        }

        async function pay() {
            const btn = document.getElementById('btn-pay');

            const passengers = [];
            let hasError = false;

            document.querySelectorAll('.b-passenger-group').forEach((group, index) => {
                const nameInp = group.querySelector('.pass-name');
                const dobInp = group.querySelector('.pass-dob');
                if (nameInp.value.trim().length < 2) { nameInp.classList.add('error'); hasError = true; }
                else nameInp.classList.remove('error');
                if (!dobInp.value) { dobInp.classList.add('error'); hasError = true; }
                else dobInp.classList.remove('error');
                passengers.push({ index: index + 1, name: nameInp.value.trim(), dob: dobInp.value });
            });

            const email = document.getElementById('inp-email').value.trim();
            const phone = document.getElementById('inp-phone').value.trim();
            if (!email.includes('@')) { document.getElementById('inp-email').classList.add('error'); hasError = true; } else document.getElementById('inp-email').classList.remove('error');
            if (phone.length < 5) { document.getElementById('inp-phone').classList.add('error'); hasError = true; } else document.getElementById('inp-phone').classList.remove('error');

            if (hasError) return;
            if (!CONFIG.webhook) return alert("Error: Webhook URL not found!");

            btn.disabled = true; btn.innerText = "Загрузка...";

            const isFull = state.payType === 'full';
            const seat = (state.isMapActive) ? CONFIG.priceSeat : 0;
            const total = (isFull ? CONFIG.priceFull : CONFIG.priceDeposit + seat) * state.count; // Fix total calculation logic for payload if needed, currently relies on UI state
            // Actually re-calculating to be safe:
            const basePrice = isFull ? CONFIG.priceFull : CONFIG.priceDeposit;
            const seatPrice = state.isMapActive ? CONFIG.priceSeat : 0;
            const finalTotal = (basePrice + seatPrice) * state.count;

            const seatsStr = state.isMapActive ? state.selectedSeats.join(', ') : "Без места";

            const payload = {
                totalPrice: finalTotal, productName: CONFIG.name, seats: seatsStr,
                count: state.count, payType: state.payType,
                customerEmail: email, customerPhone: phone,
                customerName: passengers.map(p => p.name).join(', ')
            };
            passengers.forEach(p => { payload[`passenger${p.index}_name`] = p.name; payload[`passenger${p.index}_dob`] = p.dob; });

            try {
                const res = await fetch(CONFIG.webhook, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!data.clientSecret) throw new Error("Make error");
                document.getElementById('payment-overlay').classList.add('show');
                checkout = await stripe.initEmbeddedCheckout({ clientSecret: data.clientSecret });
                checkout.mount('#stripe-box');
            } catch (e) {
                console.error(e); alert("Ошибка: " + e.message);
                btn.disabled = false; btn.innerText = "Оплатить";
            }
        }

        setTimeout(init, 1000);
    })();
</script>